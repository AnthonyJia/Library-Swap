{% extends "base.html" %}
{% load static %}

{% block content %}
<h2 class="mt-4">Borrow Books</h2>
<p>This page is for users who want to borrow books.</p>
<div class="text-end small mb-2">
  Logged in as: {{ request.user.email }}
</div>

<!-- Search form -->
<form method="get" action="">
  <div class="input-group mb-3">
    <input type="text" name="q" value="{{ query }}" class="form-control"
           placeholder="Search by title, author, or genre">
    <button class="btn btn-outline-secondary" type="submit">Search</button>
  </div>
</form>

<!-- List of books -->
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
  {% for book in books %}
    <div class="col">
      <div class="card h-100 shadow-sm border-0 book-card">

        {# --- Book cover --- #}
        {% if book.image %}
          <img src="{{ book.image.url }}" class="card-img-top book-cover" alt="{{ book.title }}">
        {% else %}
          <img src="{% static 'img/placeholder_cover.png' %}" class="card-img-top book-cover" alt="No cover available">
        {% endif %}

        {# --- Meta data --- #}
        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-center fw-bold">{{ book.title }}</h5>

          <p class="card-text book-meta mb-1"><strong>Author:</strong> {{ book.author }}</p>
          <p class="card-text book-meta mb-1"><strong>Genre:</strong> {{ book.genre }}</p>
          <p class="card-text book-meta mb-1"><strong>Description:</strong> {{ book.description|truncatewords:20 }}</p>
          <p class="card-text book-meta mb-1"><strong>Uploaded&nbsp;by:</strong> {{ book.uploader_email }}</p>

          <p class="card-text book-meta mb-3">
            <strong>Availability:</strong>
            {% if book.is_available %}Available{% else %}Borrowed{% endif %}
          </p>

          {# --- Action button --- #}
          {% if book.user != request.user %}
            <a href="{% url 'request_borrow_book' book.id %}"
              class="btn btn-primary mt-auto {% if not book.is_available %}disabled{% endif %}">
              Request to Borrow
            </a>
          {% else %}
            <p class="text-muted text-center mt-auto">This is your book.</p>
          {% endif %}
        </div>  {# /card-body #}

      </div>  {# /card #}
    </div>    {# /col #}
  {% empty %}
    <p>No books found.</p>
  {% endfor %}
</div>  {# /row #}

<div class="mt-3 mb-5">
  <a href="{% url 'choose' %}" class="btn btn-secondary">Back</a>
</div>
{% endblock %}